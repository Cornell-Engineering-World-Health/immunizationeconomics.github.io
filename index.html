<!DOCTYPE html>
<html>

<head>
  <title>CSV File to HTML Table Using AJAX jQuery</title>
  <script type="text/javascript" charset="utf8"
    src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
  <script type="text/javascript" charset="utf8"
    src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script type="text/javascript" charset="utf8"
    src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" charset="utf8"
    src="https://cdn.datatables.net/fixedheader/3.1.7/js/dataTables.fixedHeader.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.23/css/jquery.dataTables.min.css">
</head>

<body>
  <div class="container">
    <div class="table-responsive">
      <h1 align="center">Immunization Economics Job Postings</h1>
      <br />
      <div align="center">
        <button type="button" name="load_data" id="load_data" class="btn btn-info">See Jobs</button>
      </div>
      <br />
      <div id="immecs" class='collapse'>
        <input type="checkbox" name="type" value="Immunization">Immunization
        <input type="checkbox" name="type" value="Economics">Economics
      </div>
      <div id="job_postings">
      </div>
    </div>
  </div>
</body>

</html>

<script>
  $(document).ready(function () {
    $('#load_data').click(function () {
      $.ajax({
        url: "https://raw.githubusercontent.com/Cornell-Engineering-World-Health/immunizationeconomics.github.io/main/JSI_Data.csv",
        dataType: "text",
        success: function (data) {
          var full_job = data.split(/""\r?\n|\r/);
          var table_data = '<table id="job_table" class="display table table-bordered table-striped">';
          // var delcolumns = [5, 4, 0]
          for (var count = 0; count < full_job.length - 1; count++) {
            var cell_data = splitCSV(full_job[count]);
            // for (var cell = 0; cell < delcolumns.length; cell++) {
            //   cell_data.splice(delcolumns[cell], 1);
            // }
            // var cell_data = full_job[count].split(",");
            cell_data.splice(0, 1);
            if (count == 0) {
              table_data += '<thead>';
            }
            else if (count == 1) {
              table_data += '<tbody>';
            }
            table_data += '<tr>';
            for (var cell_count = 0; cell_count < cell_data.length; cell_count++) {
              if (count === 0) {
                if (cell_count == 0 || cell_count == 3 || cell_count == 6) {
                  table_data += '<th class="collapse">' + cell_data[cell_count] + '</th>';
                }
                else {
                  table_data += '<th>' + cell_data[cell_count] + '</th>';
                }
              }
              else {
                if (cell_count == 1) {
                  table_data += '<td><a href=' + cell_data[0] + '>' + cell_data[cell_count] + '</a></td>';
                }
                else if (cell_count == 0 || cell_count == 3 || cell_count == 6) {
                  table_data += '<td class="collapse">' + cell_data[cell_count] + '</td>';
                }
                else {
                  table_data += '<td>' + cell_data[cell_count] + '</td>';
                }
              }
            }
            table_data += '</tr>';
            if (count == 0) {
              table_data += '</thead>';
            }
          }
          table_data += '</tbody>';
          table_data += '</table>';
          $('#job_postings').html(table_data).ready(function () {
            $.fn.dataTable.ext.search.push(
              function (settings, searchData, index, rowData, counter) {
                var type = $('input:checkbox[name="type"]:checked').map(function () {
                  return this.value;
                }).get();

                if (type.length === 0 || type.length === 2) {
                  return true;
                }

                if ((type.indexOf(searchData[3]) !== -1) || searchData[3] === 'Both') {
                  return true;
                }

                return false;
              }
            );
            $('#immecs').removeClass('collapse')
            $('#immecs').addClass('show')

            var table = $('#job_table').DataTable();
            $('input:checkbox').on('change', function () {
              table.draw();
            });
          });

        }
      });
    })
  });
</script>
<script>
  function splitCSV(str) {
    //split the str first
    //then merge the elments between two double quotes
    var delimiter = ',';
    var quotes = '"';
    var elements = str.split(delimiter);
    var newElements = [];
    for (var i = 0; i < elements.length; ++i) {
      if (elements[i].indexOf(quotes) >= 0) {//the left double quotes is found
        var indexOfRightQuotes = -1;
        var tmp = elements[i];
        //find the right double quotes
        for (var j = i + 1; j < elements.length; ++j) {
          if (elements[j].indexOf(quotes) >= 0) {
            indexOfRightQuotes = j;
            break;
          }
        }
        //found the right double quotes
        //merge all the elements between double quotes
        if (-1 != indexOfRightQuotes) {
          for (var j = i + 1; j <= indexOfRightQuotes; ++j) {
            tmp = tmp + delimiter + elements[j];
          }
          newElements.push(tmp);
          i = indexOfRightQuotes;
        }
        else { //right double quotes is not found
          newElements.push(elements[i]);
        }
      }
      else {//no left double quotes is found
        newElements.push(elements[i]);
      }
    }

    return newElements;
  }
</script>
